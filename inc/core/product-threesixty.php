<?php
/**
 * WooCommerce Product Threesixty
 *
 * @link https://woocommerce.com/
 *
 * @package kraftiart
 */

add_action('woocommerce_single_product_product_360_view', 'kraftiart_product_360_view', 10);
if ( ! function_exists( 'kraftiart_product_360_view') ) {
	/**
	 * Product 360 view
	 */
	function kraftiart_product_360_view() {
		global $post;
		$images = get_post_meta( $post->ID, 'tt-360-metabox', true);
		if ( empty( $images ) ){ return; }

		$id = rand(100, 999);
		$title = '';
		$frames_count = count($images);
		$images_js_string = '';
		?>
		<div class="product-360-button-wrap">
			<div class="product-360-button">
				<a class="product-popup" href="<?php esc_attr_e( '#product-360-view', 'kraftiart' ); ?>" title="<?php esc_attr_e( 'Product 360 view', 'kraftiart' ); ?>"><svg width="30" height="15" viewBox="0 0 33 17" fill="none" xmlns="http://www.w3.org/2000/svg">
<path fill-rule="evenodd" clip-rule="evenodd" d="M4.40011 8.2128C-1.25747 11.1798 13.9821 12.9819 17.4153 12.9527V11.1433L20.2683 13.8672L17.4153 16.5958V14.9007C10.5158 15.1512 -5.72397 10.9074 4.04381 7.38593C4.13543 7.66074 4.24741 7.92097 4.37466 8.16416L4.40011 8.2128ZM30.1389 2.61682C30.1389 1.98207 30.2585 1.53702 30.4977 1.28409C30.737 1.03116 31.1009 0.904702 31.5921 0.904702C31.8262 0.904702 32.0222 0.933886 32.1723 0.987389C32.3225 1.04332 32.4472 1.11385 32.5414 1.20384C32.6381 1.29139 32.7119 1.38623 32.7679 1.48351C32.8239 1.58079 32.8671 1.6951 32.9002 1.82642C32.9664 2.07448 32.9969 2.33471 32.9969 2.60709C32.9969 3.21265 32.89 3.6577 32.6737 3.93738C32.4599 4.21706 32.0909 4.35811 31.5641 4.35811C31.2714 4.35811 31.0322 4.31191 30.8515 4.22436C30.6708 4.13437 30.5206 4.00305 30.4061 3.83037C30.3221 3.70634 30.2559 3.53854 30.2101 3.32695C30.1618 3.11051 30.1389 2.87704 30.1389 2.61682ZM7.73408 3.14699L5.44357 2.75787C5.63444 2.06232 5.99838 1.52729 6.54047 1.1552C7.08001 0.783103 7.84606 0.59584 8.83607 0.59584C9.9737 0.59584 10.7932 0.797695 11.3022 1.20384C11.8087 1.60998 12.0606 2.12069 12.0606 2.73355C12.0606 3.09348 11.9563 3.41937 11.7527 3.70878C11.5465 4.00061 11.2386 4.25597 10.8237 4.47485C11.1597 4.5551 11.4193 4.64752 11.5949 4.75453C11.885 4.92477 12.109 5.15094 12.2693 5.42819C12.4296 5.70786 12.5111 6.03861 12.5111 6.4253C12.5111 6.91169 12.3787 7.3762 12.1141 7.82369C11.8468 8.26874 11.4651 8.61165 10.9663 8.85241C10.4674 9.09318 9.81082 9.21235 8.99641 9.21235C8.20491 9.21235 7.57884 9.12236 7.12328 8.94483C6.66517 8.7673 6.28851 8.50707 5.99329 8.16173C5.69807 7.81882 5.47156 7.38593 5.31377 6.86549L7.73917 6.55662C7.83588 7.02356 7.98095 7.34945 8.18201 7.53185C8.38052 7.71182 8.63502 7.80423 8.94551 7.80423C9.26873 7.80423 9.5385 7.68993 9.75483 7.46375C9.97115 7.23758 10.078 6.93358 10.078 6.55419C10.078 6.16751 9.9737 5.86837 9.76755 5.65679C9.5614 5.44521 9.27891 5.3382 8.92261 5.3382C8.73427 5.3382 8.47214 5.38198 8.14128 5.47439L8.26599 3.81821C8.39833 3.83767 8.50268 3.8474 8.57648 3.8474C8.88952 3.8474 9.15166 3.75012 9.36035 3.55799C9.56904 3.36587 9.67593 3.13969 9.67593 2.87461C9.67593 2.61925 9.59703 2.41739 9.43924 2.26904C9.28145 2.11826 9.06258 2.04287 8.79026 2.04287C8.50522 2.04287 8.27617 2.12556 8.09802 2.2885C7.91732 2.44901 7.79771 2.73598 7.73408 3.14699ZM20.1232 2.60709L17.7106 2.8892C17.6469 2.56818 17.5426 2.34443 17.395 2.21311C17.2448 2.08178 17.0616 2.01612 16.8452 2.01612C16.4533 2.01612 16.1479 2.20338 15.9316 2.58277C15.7738 2.85758 15.6542 3.43883 15.5804 4.33136C15.8705 4.04925 16.1683 3.84253 16.4711 3.70878C16.7765 3.57502 17.1303 3.50692 17.5299 3.50692C18.3086 3.50692 18.9652 3.77201 19.5022 4.30218C20.0392 4.83478 20.309 5.50844 20.309 6.32315C20.309 6.87278 20.1741 7.37377 19.9018 7.83098C19.6295 8.28576 19.2528 8.6311 18.7718 8.86457C18.2883 9.09804 17.6851 9.21478 16.9572 9.21478C16.0843 9.21478 15.3844 9.07372 14.8576 8.78675C14.3308 8.50221 13.9083 8.04986 13.5927 7.42727C13.2771 6.80469 13.1193 5.98025 13.1193 4.95152C13.1193 3.44855 13.4502 2.34687 14.1144 1.64646C14.7736 0.946046 15.6924 0.59584 16.8682 0.59584C17.5629 0.59584 18.1101 0.671232 18.5122 0.824447C18.9143 0.977661 19.2503 1.20384 19.515 1.49567C19.7822 1.79237 19.9858 2.16204 20.1232 2.60709ZM15.6618 6.32315C15.6618 6.7755 15.7814 7.12814 16.0181 7.3835C16.2573 7.63886 16.5475 7.76775 16.8936 7.76775C17.2117 7.76775 17.479 7.65102 17.6927 7.41998C17.9065 7.18894 18.0134 6.8436 18.0134 6.38395C18.0134 5.91458 17.9014 5.55465 17.68 5.30902C17.4561 5.06339 17.1812 4.93936 16.8503 4.93936C16.5144 4.93936 16.2294 5.05852 16.0003 5.29929C15.7738 5.53762 15.6618 5.8781 15.6618 6.32315ZM20.8257 4.86883C20.8257 3.28561 21.1234 2.17663 21.7215 1.54431C22.317 0.911998 23.2281 0.59584 24.4472 0.59584C25.0351 0.59584 25.5161 0.666368 25.8928 0.802559C26.2694 0.941182 26.5774 1.12115 26.8141 1.34246C27.0533 1.56377 27.2416 1.79724 27.3765 2.04044C27.514 2.28607 27.6234 2.57061 27.7074 2.89649C27.8703 3.51665 27.9517 4.16599 27.9517 4.84208C27.9517 6.35477 27.6845 7.45889 27.1475 8.1593C26.613 8.85971 25.6917 9.20991 24.381 9.20991C23.6481 9.20991 23.0551 9.09804 22.6021 8.8743C22.1491 8.65056 21.78 8.32224 21.4899 7.88935C21.2812 7.58292 21.1158 7.16462 20.9987 6.63202C20.8842 6.10184 20.8257 5.5133 20.8257 4.86883ZM23.2256 4.87369C23.2256 5.93404 23.3223 6.65877 23.5208 7.04788C23.7168 7.437 24.0018 7.62913 24.376 7.62913C24.6228 7.62913 24.8341 7.54644 25.0148 7.3835C25.1954 7.21812 25.3278 6.95547 25.4118 6.6004C25.4983 6.2429 25.539 5.68841 25.539 4.93449C25.539 3.82794 25.4423 3.08619 25.2438 2.70194C25.0478 2.32255 24.7526 2.13042 24.3607 2.13042C23.9586 2.13042 23.671 2.32498 23.4903 2.71166C23.3147 3.10321 23.2256 3.82308 23.2256 4.87369ZM31.1009 2.61925C31.1009 3.04484 31.1391 3.33425 31.218 3.4899C31.2969 3.64554 31.4114 3.72337 31.5615 3.72337C31.6608 3.72337 31.7448 3.69175 31.8186 3.62366C31.8899 3.55799 31.9433 3.45342 31.9789 3.30993C32.012 3.16644 32.0298 2.94513 32.0298 2.64357C32.0298 2.20095 31.9917 1.90181 31.9128 1.7486C31.8339 1.59538 31.7168 1.51999 31.559 1.51999C31.3987 1.51999 31.2816 1.59782 31.2103 1.75346C31.1365 1.90911 31.1009 2.19852 31.1009 2.61925ZM28.8145 7.94772C31.502 9.25369 30.8607 11.1069 26.1015 12.2329C24.7526 12.5515 23.2282 12.8409 21.5561 12.96V14.4314C23.4165 14.3073 25.1471 13.8988 26.6614 13.5486C33.818 11.8924 33.5686 8.9351 29.0435 7.26676C28.9799 7.50753 28.9035 7.7337 28.8145 7.94772Z" fill="black"></path>
</svg></a>
			</div>
			<div id="product-360-view" class="product-360-view-wrapper mfp-hide">
				<div class="tt-360-veiw threed-id-<?php echo esc_attr( $id ); ?>">
					<?php if ( !empty( $title ) ): ?>
						<h3 class="threed-title"><span><?php echo esc_html( $title ); ?></span></h3>
					<?php endif ?>
					<ul class="threed-view-images">
						<?php
						if ( count( $images ) > 0 ):
							$i = 0;
							foreach ( $images as $img_id ) : $i++;
								$img = wp_get_attachment_image_src($img_id, 'full');
								$width = $img[1];
								$height = $img[2];
								$images_js_string .= "'" . $img[0] . "'";
								if ($i < $frames_count) {
									$images_js_string .= ",";
								}
							endforeach;
						endif; ?>
					</ul>
					<div class="spinner">
						<span><?php esc_html_e( '0%', 'kraftiart' ); ?></span>
					</div>
				</div>
				<script>
					jQuery(document).ready(function() {
						jQuery('.threed-id-<?php echo esc_attr($id); ?>').ThreeSixty({
							totalFrames: <?php echo esc_attr($frames_count); ?>,
							endFrame: <?php echo esc_attr($frames_count); ?>,
							currentFrame: 1,
							imgList: '.threed-view-images',
							progress: '.spinner',
							imgArray: [<?php echo htmlentities($images_js_string); ?>],
							
							height: <?php echo esc_attr( $height ); ?>,
                            width: <?php echo esc_attr( $width ); ?>,
							responsive: true,
							navigation: true
						});
					});
				</script>
			</div>
		</div>
		<?php
	}
}
